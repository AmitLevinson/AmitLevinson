---
title: An SQL interview question to learn from
author: Amit Levinson
date: '2021-07-08'
slug: a-great-sql-questions
categories: []
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: ''
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: yes
draft: true
projects: []
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
```


Structure:

## Intro

- Intro on job search process

During the first half of 2021, as I was finishing up my M.A. thesis, I started searching for a job in Data Analytics. [My journey into analytics was through learning R](https://amitlevinson.com/blog/my-year-in-r/) and I realized I had to learn some SQL, or at least familiarize myself with it.

Most of the SQL interview questions were pretty good. They cheked if you knew how to solve A or use something such as a window function, Having, LEAD, etc. But one question I was really fond of and thought about it since; this blog post details the question and several answers to it.

**The question and data do not represent my current employer.** The data used here is made up and the question came from a different company. While not necessary, some SQL knowledge is useful to understanding the answers' syntax.

## The Interview question

Let's say you have a table with payments information. The table has users' names, the date of their last payment and the amount they received. For each seller, return their name, the last date of their payment and the amount received on that date. I'll be using R to setup a connection in memory but power through with SQL for the rest of the post.

Now to our question, Considering the following raw data:

```{r}
library(dbplyr)
library(dplyr)
library(gt)

set.seed(123)

# create the data
payments <- data.frame(
  User = rep(c("Danny", "Barbra", "Tom"), each = 4),
  Payment_Date = sample(seq(as.Date('2021-05-07'), as.Date('2021-07-07'), by = 'day'), 12),
  amount = sample.int(100, 12)
)


conn <- src_memdb()
conn_isolated <- conn$con
copy_to(conn, payments, overwrite = TRUE)

# Close connection
# DBI::dbDisconnect(conn_isolated)
```


```{r, fig.align = 'left'}
raw_payments <- payments %>% 
  arrange(amount, Payment_Date)
  gt(raw_payments) %>% 
    tab_style(
      style = cell_fill(color = 'lightgreen'),
      locations = cells_body (
        rows = c(4,8,12)
      )
    )
```

return the following table:

```{r}
payments %>% 
  group_by(User) %>% 
  filter(amount == max(amount)) %>% 
  ungroup() %>% 
  gt()
```

All right. So we know what we have to do. But before we do it, let's see how not to do it.

```{sql connection=conn_isolated, echo = TRUE}
SELECT User, Payment_Date as 'Payment Date', amount
FROM (
  SELECT *,
    DENSE_RANK() OVER(Partition BY User Order by Payment_Date DESC) as rnk
  FROM payments)
WHERE rnk = 1;  
```





```{sql connection=conn_isolated, echo = TRUE}
SELECT User,
  Payment_Date,
  amount
  FROM Payments p
  WHERE amount = (SELECT amount
                          FROM Payments pp
                          WHERE pp.User = p.User -- Notice the relation to the parent table
                          ORDER By amount DESC
                          limit 1)
  GROUP BY User;
```

### Why not just a simple GROUP BY?

An immediate question that might come to mind is why not use a simple `GROUP BY` and return the `MAX` value. I.e., just filter each group by the max value according to one of the variables.  

The issue is when we use `GROUP BY` we retrieve only the information that is aggregated. That is, if we group by the sellers name and return the max we only get those two columns -- User and max amount (without the date). Alternatively, if we `GROUP BY` the seller and product name and return the `MAX` value we'll get the information for each seller and every product of theirs.

For example, let's show both approaches here:

```{sql connection=conn_isolated, echo = TRUE}
SELECT USER,
  MAX(amount)
FROM Payments 
GROUP BY User
```
```{sql connection=conn_isolated, echo = TRUE}
SELECT User,
  Payment_Date,
  max(amount)
FROM Payments
GROUP BY User
```


SHOW BOTH Queries

  - various questions
  
  - Not representing my employer

  - Some basic knowledge of SQL (or R also if you ask me) can help

## The case

- show the case with the question

- provide the question with another one - reframed

## Solutions

### 1. Window functions

### 2. Self Join

### 3. Correlated subquery

