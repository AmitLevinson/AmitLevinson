---
title: Golda Ice Cream Locations in Israel
author: Amit Levinson
date: '2021-01-03'
slug: exploring-ice-cream-locations
categories: [R, GitHub]
tags: [TidyTuesday, GitHub]
subtitle: ''
summary: 'a light introduction to GitHub Actions for automating a plot of frequently used R packages.'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: yes
projects: []
draft: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{css, echo = FALSE}
newcaption {
  font-size: 0.9em;
  text-align: center;
}
```

```{r}
library(dplyr)
library(readr)
library(purrr)
library(leaflet)
library(glue)
library(htmltools)
library(sf)
library(here)
library(ggplot2)
library(ggspatial)
```

Let' explore the ice cream locations throughout the country

```{r}
golda_locations <- read_csv("content/post/ice-cream-locations/golda_locations.csv") %>% 
  mutate(id = 1:nrow(.))
```

How many locations do we have?

```{r}
nrow(golda_locations)
```

Let's see where they are across Israel:

```{r}
make_label <- function(x, y, n){
  glue("<p style='text-align:right;font-family:Calibri;font-size:14px;'>
  <b>{x}</b></span><br/>
  {y}</span><br/>
  <span style='color:#808080'>{n}</p>") %>% 
    HTML()
}
# Create labels
ice_cream_labels <- pmap(list(golda_locations$city, golda_locations$street,golda_locations$number), make_label)
# Use an icon for points
ice_cream_icon <-  makeIcon("https://upload.wikimedia.org/wikipedia/commons/2/2c/Ice-cream-solid.svg", iconWidth = 12, iconHeight = 16)

# Draw map
leaflet() %>% 
  addTiles(data = golda_locations) %>% 
  addMarkers(data = golda_locations, icon = ice_cream_icon, label = ~ ice_cream_labels)# %>% 
  #addPolygons(data = grid_wg, fill = "blue", fillOpacity = 0.1, weight = 0.3)
```

### Israel map

```{r}
golda_projected <- golda_locations %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326)
golda_meters <- st_transform(golda_projected, crs = 2039)
```


```{r}
isr_map_sf <- st_read("static/data/maps/israel/israel_borders.shp") %>% st_transform(crs = 4326)
isr_map_rds <- readRDS("content/post/ice-cream-locations/maps/00_Israel_0_sf.rds")
  
isr_map <- st_transform(isr_map_sf, crs = 2039)
new_isr <- st_make_grid(isr_map,  cellsize = 5000)
grid <- st_intersection(new_isr, isr_map)

write_rds(grid, "content/post/ice-cream-locations/new_isr.Rds")
# write_rds(grid, "content/post/ice-cream-locations/grid.Rds")

plot(grid)

golda_meters <- st_transform(st_geometry(golda_projected), crs = 2039)

dataum <- data.frame(
  geometry = st_geometry(golda_projected[3:9,]),
  location_grid = st_centroid(rep(grid[309,],7)))

  #dist = st_distance(golda_projected[1:5,], grid_test[1,])/1000

data_lines <- map_dfc(dataum, ~ st_transform(.x, crs = 2039)) 

  # No need to convert to specific lat-long?? Just use sfc_Point:

sample_data <- data_lines %>% 
  map_dfc(~ st_transform(.x, crs = 4326) %>% st_coordinates(.x)) %>% 
  map_dfc(as.data.frame) %>% 
  set_names(c("golda.x","golda.y", "us.x" ,"us.y")) %>% 
  cbind(distance = map2_dbl(data_lines$geometry, data_lines$geometry.1,  st_distance),
        location_polygon = st_transform(data_lines$geometry.1, crs = 4326)) %>% 
  mutate(relevant = ifelse(distance == min(distance), "yes", "no"),
         distance = ifelse(relevant == "yes", paste0(round(distance/1000, 0), "km"), round(distance/1000, 0)))

ggplot(isr_map_sf)+
  geom_sf()+
  geom_sf(data = grid[309,])+
  geom_point(data = sample_data,mapping= aes(x = golda.x, y = golda.y, color = relevant))+
  geom_spatial_segment(data = sample_data, mapping = aes(x = us.x, xend = golda.x, y = us.y, yend = golda.y, linetype = relevant, color = relevant), show.legend = FALSE)+
  geom_point(data = sample_data,mapping= aes(x = us.x, y = us.y), color = "red", size = 0.1)+
  geom_spatial_text_repel(data = sample_data, mapping = aes(x = golda.x,  y = golda.y, label = distance, color = relevant), crs = 4326, hjust = 0.5)+
  scale_color_manual(values = c("yes" = "red", "no" = "gray55"))+
  scale_linetype_manual(values = c("dashed","solid"))+
  # Remove legends
  guides(color = "none")+
  theme_void()
```

Now that we split our geographic area into 5km^2, and showed how we find the near value for each section, we can do so for all areas. This will result in a map indicating the nearest Golda ice cream shop within a 5km^2 distance:

```{r}
distances <- st_distance(golda_meters, st_centroid(grid)) %>% 
  as_tibble()

golda_distances <- data.frame(
  us = st_transform(grid, crs = 4326),
  # Extract minimum distance for each grid
  distance_km = map_dbl(distances, min)/1000,
  # Extract the value's index for joining with the ice-cream loc info
  location_id = map_dbl(distances, function(x) match(min(x), x))) %>% 
  left_join(golda_projected, by = c("location_id" = "id"))
```

```{r}
# Draw map
grid_polygons <- golda_distances$geometry.x
  
ice_cream_icon <-  makeIcon("https://upload.wikimedia.org/wikipedia/commons/2/2c/Ice-cream-solid.svg", iconWidth = 6, iconHeight = 8)

bins <- c(70,50,25,10,5,0)
pal <- colorBin("OrRd", domain = golda_distances$distance_km, bins = bins)

make_label_distances <- function(x, y, n){
  glue("
  <p style='text-align:right;font-family:Calibri;font-size:14px;'>
  הסניף הקרוב במרחק של כ-<b>{round(x, 0)}</b></span>
 ק'מ בכתובת<br>
  {y}, {n}</span></p>") %>% 
    HTML()
}
# Create labels

ice_cream_labels <- pmap(list(golda_distances$distance_km, golda_distances$street,golda_distances$city ), make_label_distances)

leaflet() %>% 
  addTiles() %>% 
  addMarkers(data = golda_projected, icon = ice_cream_icon, group = "Ice-cream locations") %>% 
  addPolygons(data = grid_polygons, fillColor = pal(golda_distances$distance_km), fillOpacity = 0.7, weight =0, opacity =1, color = "transparent", group = "Distances", popup = ice_cream_labels, 
            highlight = highlightOptions(weight = 2.5, color = "#666", bringToFront = TRUE, opacity= 1),
            popupOptions = popupOptions(autoPan = FALSE,closeOnClick = TRUE, textOnly = T, style = list("size" = "22"))) %>% 
  addLegend(pal = pal, values = (golda_distances$distance_km), opacity = 0.8, 
                         title = "Distance in Km", position= "bottomright") %>% 
  addLayersControl(overlayGroups = c("Ice-cream locations", "Distances"),
                   options = layersControlOptions(collapsed = FALSE))
```


### Static maps

We can also visualize it on a static map, allowing us to export it if we wish.

```{r}
golda_distances_static <- golda_distances %>% 
  mutate(binned_colors = cut(distance_km, breaks = c(70,50,25,10,5,0)))

ggplot(golda_distances_static)+
  geom_sf(data = isr_map_sf, aes(geometry = geometry))+
  geom_sf(aes(geometry = geometry.x, fill =  binned_colors), color = "transparent")+
  geom_point(golda_locations, mapping = aes(x = lon, y= lat), size = .5)+
  scale_fill_brewer(name = "Distance (km)", palette = "OrRd", labels = c("0-5", "5-10", "10-25", "25-50", "50-70"))+
  xlim(34,36)+
  labs(title = "Distance from Golda Ice-cream locations", subtitle = "Colors represent distance from the center of a 5km^2 area")+
  guides(fill = guide_legend(reverse = TRUE))+
  #theme_void()+
  theme(text = element_text(),
        plot.title = element_text(color = "#0C0C44", face = "bold", size = 18),
        plot.title.position = "plot",
        plot.subtitle = element_markdown(color = "gray35", size = 14),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10))

ggsave("content/post/ice-cream-locations/israel_map.png", width = 5, height = 8)
```



Tutorials:
https://michaeldorman.github.io/R-Spatial-Workshop-at-CBS-2021/main.html